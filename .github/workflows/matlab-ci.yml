name: MATLAB CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run MATLAB Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2023b
      
      - name: Run MATLAB build
        uses: matlab-actions/run-build@v2
        with:
          tasks: test
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
      
      - name: Upload code coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage
          path: code-coverage/

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2023b
      
      - name: Run MATLAB build
        uses: matlab-actions/run-build@v2
        with:
          tasks: check

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [test, code-quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2023b
      
      - name: Generate documentation
        run: |
          mkdir -p docs/html
          echo "<html><head><title>MATLAB Physics Simulations Documentation</title></head>" > docs/html/index.html
          echo "<body><h1>MATLAB Physics Simulations</h1>" >> docs/html/index.html
          echo "<p>This project provides physics simulations including pendulum, particle dynamics, and wave equation solvers.</p>" >> docs/html/index.html
          echo "<h2>Available Functions</h2><ul>" >> docs/html/index.html
          echo "<li><b>pendulum_simulation</b> - Simulates pendulum motion with optional damping</li>" >> docs/html/index.html
          echo "<li><b>particle_dynamics</b> - Simulates 3D particle motion under external forces</li>" >> docs/html/index.html
          echo "<li><b>wave_equation_solver</b> - Solves 1D wave equation with various boundary conditions</li>" >> docs/html/index.html
          echo "<li><b>create_mass_spring_damper_model</b> - Creates Simulink model for mass-spring-damper system</li>" >> docs/html/index.html
          echo "<li><b>plot_phase_space</b> - Plots phase space diagram for dynamical systems</li>" >> docs/html/index.html
          echo "</ul>" >> docs/html/index.html
          echo "<h2>Demo Script</h2>" >> docs/html/index.html
          echo "<p>Run <code>run_all_demos</code> in MATLAB to see demonstrations of all simulations.</p>" >> docs/html/index.html
          echo "<p>See the <a href='https://github.com/murr2k/matlab-app-dev'>GitHub repository</a> for source code and examples.</p>" >> docs/html/index.html
          echo "</body></html>" >> docs/html/index.html
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/html